# PocketBase Integration Summary

## Overview

This document provides a comprehensive overview of the PocketBase integration into the Prompt-to-Project Starter application.

## What is PocketBase?

PocketBase is an open-source backend consisting of:
- **Database**: Embedded SQLite (or PostgreSQL/MySQL)
- **Authentication**: Built-in auth with multiple providers
- **API**: RESTful API with real-time subscriptions
- **Admin UI**: Web-based dashboard
- **File Storage**: Built-in file handling
- **Single Binary**: No dependencies, easy deployment

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                        React Frontend                        │
│  ┌────────────┐  ┌──────────────┐  ┌──────────────────┐   │
│  │ Components │  │   Contexts   │  │    Services      │   │
│  │            │  │              │  │                  │   │
│  │ - AuthForm │  │ - AuthContext│  │ - authService    │   │
│  │ - Project  │  │              │  │ - projectHistory │   │
│  │   History  │  │              │  │   Service        │   │
│  └────────────┘  └──────────────┘  └──────────────────┘   │
│                          │                    │             │
│                          └────────────────────┘             │
│                                   │                         │
└───────────────────────────────────┼─────────────────────────┘
                                    │
                          ┌─────────▼─────────┐
                          │  PocketBase SDK   │
                          │  (lib/pocketbase) │
                          └─────────┬─────────┘
                                    │ HTTP/REST
                          ┌─────────▼─────────┐
                          │   PocketBase      │
                          │   Server          │
                          │                   │
                          │ - Auth API        │
                          │ - Collections API │
                          │ - Real-time       │
                          └─────────┬─────────┘
                                    │
                          ┌─────────▼─────────┐
                          │   SQLite DB       │
                          │   (pb_data/)      │
                          └───────────────────┘
```

## File Structure

```
/project
├── lib/
│   └── pocketbase.ts          # PocketBase client configuration
├── services/
│   ├── authService.ts          # Authentication operations
│   ├── projectHistoryService.ts# Project CRUD operations
│   └── geminiService.ts        # AI generation (unchanged)
├── contexts/
│   └── AuthContext.tsx         # Auth state management
├── components/
│   ├── AuthForm.tsx            # Login/signup UI
│   ├── ProjectHistory.tsx      # Project list with async loading
│   ├── SaveProjectDialog.tsx   # Save dialog
│   └── Toast.tsx               # Notifications
├── scripts/
│   └── check-pocketbase.js     # Health check utility
├── .env.local.example          # Environment variables template
├── pocketbase_schema.md        # Database schema documentation
├── QUICKSTART.md               # Quick setup guide
├── MIGRATION.md                # Migration from localStorage
└── README.md                   # Full documentation
```

## Collections Schema

### users (Auth Collection)

| Field  | Type   | Required | Notes                    |
|--------|--------|----------|--------------------------|
| id     | Text   | Auto     | UUID generated by PB     |
| email  | Email  | Yes      | Unique, used for login   |
| name   | Text   | Yes      | Display name             |
| avatar | File   | No       | Profile picture          |
| created| Date   | Auto     | Account creation         |
| updated| Date   | Auto     | Last update              |

**Built-in fields (inherited from auth collection):**
- password (hashed)
- emailVisibility
- verified

### projects (Base Collection)

| Field       | Type     | Required | Notes                        |
|-------------|----------|----------|------------------------------|
| id          | Text     | Auto     | UUID generated by PB         |
| user        | Relation | Yes      | Links to users collection    |
| name        | Text     | Yes      | Project name (max 200 chars) |
| description | Text     | No       | Short description (max 500)  |
| options     | JSON     | Yes      | ProjectOptions object        |
| files       | JSON     | Yes      | FileNode[] array             |
| created     | Date     | Auto     | Creation timestamp           |
| updated     | Date     | Auto     | Last update timestamp        |

## API Endpoints

### Authentication

```
POST   /api/collections/users/records
       Body: { email, password, passwordConfirm, name }
       Returns: User record

POST   /api/collections/users/auth-with-password
       Body: { identity, password }
       Returns: { token, record }

POST   /api/collections/users/auth-refresh
       Returns: { token, record }

POST   /api/collections/users/request-password-reset
       Body: { email }

POST   /api/collections/users/confirm-password-reset
       Body: { token, password, passwordConfirm }
```

### Projects

```
GET    /api/collections/projects/records
       Query: filter, sort, page, perPage
       Returns: { items[], page, perPage, totalItems, totalPages }

POST   /api/collections/projects/records
       Body: { user, name, description, options, files }
       Returns: Project record

GET    /api/collections/projects/records/:id
       Returns: Project record

PATCH  /api/collections/projects/records/:id
       Body: Partial project data
       Returns: Updated project record

DELETE /api/collections/projects/records/:id
       Returns: 204 No Content
```

## Security Features

### Authentication
- ✅ Bcrypt password hashing
- ✅ JWT token-based sessions
- ✅ Token auto-refresh
- ✅ Secure HTTP-only cookies (configurable)
- ✅ CORS protection

### Authorization
- ✅ Row-level security via API rules
- ✅ Users only access their own projects
- ✅ Cascade delete on user removal
- ✅ Request validation

### API Rules

**users collection:**
- List: Authenticated users only
- Create: Public (for registration)
- Update: Own record only
- Delete: Own record only

**projects collection:**
- List: `user = @request.auth.id`
- Create: `@request.auth.id != "" && @request.data.user = @request.auth.id`
- Update: `user = @request.auth.id`
- Delete: `user = @request.auth.id`

## Environment Variables

```env
# Required
VITE_GEMINI_API_KEY=your_gemini_api_key

# Optional (defaults to localhost)
VITE_POCKETBASE_URL=http://127.0.0.1:8090
```

## Development Workflow

### 1. Start PocketBase
```bash
./pocketbase serve
```

Runs on: http://127.0.0.1:8090

### 2. Access Admin UI
Open: http://127.0.0.1:8090/_/

Create admin account on first visit.

### 3. Verify Connection
```bash
npm run check:pb
```

### 4. Start Frontend
```bash
npm run dev
```

Runs on: http://localhost:3000

## Production Deployment

### PocketBase Deployment Options

**1. Self-hosted VPS (Recommended)**
```bash
# Ubuntu/Debian
wget https://github.com/pocketbase/pocketbase/releases/download/v0.22.0/pocketbase_0.22.0_linux_amd64.zip
unzip pocketbase_0.22.0_linux_amd64.zip
chmod +x pocketbase

# Create systemd service
sudo nano /etc/systemd/system/pocketbase.service

# Enable and start
sudo systemctl enable pocketbase
sudo systemctl start pocketbase
```

**2. Docker**
```dockerfile
FROM alpine:latest
RUN apk add --no-cache ca-certificates
COPY pocketbase /usr/local/bin/
EXPOSE 8090
CMD ["pocketbase", "serve", "--http=0.0.0.0:8090"]
```

**3. Cloud Platforms**
- Railway (https://railway.app)
- Render (https://render.com)
- DigitalOcean App Platform
- Fly.io

### Frontend Deployment

Build and deploy to:
- Vercel
- Netlify
- Cloudflare Pages
- AWS S3 + CloudFront

```bash
npm run build
# Upload dist/ folder to hosting
```

### Production Checklist

- [ ] Enable HTTPS on PocketBase
- [ ] Configure SMTP for emails
- [ ] Set up database backups
- [ ] Configure CORS for frontend domain
- [ ] Update `VITE_POCKETBASE_URL` to production URL
- [ ] Enable rate limiting
- [ ] Monitor PocketBase logs
- [ ] Set up SSL certificates
- [ ] Configure firewall rules

## Monitoring & Maintenance

### Health Check
```bash
curl http://127.0.0.1:8090/api/health
```

### Logs
PocketBase logs to stdout. For production:
```bash
./pocketbase serve > logs/app.log 2>&1
```

### Backups

**Automatic (Built-in):**
PocketBase creates automatic backups in `pb_data/backups/`

**Manual:**
```bash
# Backup
cp -r pb_data/ pb_data_backup_$(date +%Y%m%d)

# Restore
./pocketbase serve --dataDir=pb_data_backup_20240101
```

### Database Management

Access SQLite directly:
```bash
sqlite3 pb_data/data.db
.tables
.schema projects
SELECT COUNT(*) FROM projects;
```

## Troubleshooting

### Issue: Cannot connect to PocketBase
**Solution:**
- Verify PocketBase is running: `ps aux | grep pocketbase`
- Check port: `netstat -an | grep 8090`
- Test endpoint: `curl http://127.0.0.1:8090/api/health`

### Issue: Authentication fails
**Solution:**
- Clear browser localStorage
- Check PocketBase logs
- Verify users collection exists
- Test with admin UI first

### Issue: Projects not saving
**Solution:**
- Verify projects collection exists
- Check API rules are correct
- Look at network tab in browser dev tools
- Check PocketBase logs for errors

### Issue: CORS errors in production
**Solution:**
```bash
# Start PocketBase with CORS origin
./pocketbase serve --origins="https://yourdomain.com"
```

## Performance Considerations

### Database
- SQLite handles ~100k requests/day easily
- For more, use PostgreSQL/MySQL
- Add indexes on frequently queried fields

### Caching
- PocketBase caches API responses
- Browser caches auth tokens
- Consider CDN for static assets

### Optimization
- Use pagination for large datasets
- Implement search debouncing
- Lazy load project history
- Compress large JSON fields

## Additional Resources

- **PocketBase Docs**: https://pocketbase.io/docs/
- **API Reference**: https://pocketbase.io/docs/api-records/
- **GitHub**: https://github.com/pocketbase/pocketbase
- **Discord Community**: https://discord.gg/pocketbase

## Summary

✅ **Secure**: Proper authentication and authorization  
✅ **Scalable**: Can handle production workloads  
✅ **Simple**: Single binary, easy deployment  
✅ **Feature-rich**: Auth, database, API, admin UI  
✅ **Open Source**: MIT licensed, self-hostable  
✅ **Developer-friendly**: Great DX, good documentation  

The PocketBase integration transforms this from a demo app into a production-ready application with proper security, persistence, and multi-user support.
